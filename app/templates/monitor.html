<script src="/socket.io/socket.io.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
<script src="http://aishek.github.io/jquery-animateNumber/javascripts/jquery.animateNumber.js"></script>
<script>
  var socket = io.connect('/{{tableid}}');
  socket.on('active', function(data){
    if($('.dataRow[rel="'+data.position+'"]').length != 1){
      refreshTable();
    }

  });
  socket.on('players', function (data) {
    if($('.dataRow[rel="'+data.position+'"]').length != 1){
      refreshTable();
    } else {
      if(data.action != "leave"){
        $('.dataRow[rel="'+data.position+'"] > td').each(function(){
          var it = $(this).attr('class');
          $(this).text(data[it]);
        });
      }
      if(data.action == "leave"){
        $('.dataRow[rel="'+data.position+'"] > td').slideUp();
      }
    }
  });
</script>
<link href='http://fonts.googleapis.com/css?family=Josefin+Sans:700italic' rel='stylesheet' type='text/css'>
<style>
body, td{ font-family: 'Josefin Sans', sans-serif;}
local#commanderName{ font-size: 16px; text-transform: capitalize;}
#lifeTotal{ font-size: 30px; text-align: right; padding-right: 10px; }
#colorWheel{ width: 50px;}
#card{
     border-radius: 90px 90px 90px 90px;
     -moz-border-radius: 90px 90px 90px 90px;
     -webkit-border-radius: 90px 90px 90px 90px;
     background:black;
}
.highlight > td{font-weight: bold; color: blue;}
</style>
<table id="players" width="600">
  <tr>
    <th>Position</th>
    <th>Player</th>
    <th>Commander</th>
    <th>Phone ID</th>
    <th>Life</th>
  </tr>
</table>
<table id="log" width="600"></table>
<script>
function refreshTable(){
  $.getJSON('/player/get?tableid={{tableid}}', function(data){
    $('.dataRow').remove();
    for(i in data){
      var html = '';
      html += '<tr class="dataRow" rel="'+data[i].position+'">';
      html += '  <td class="position">' + data[i].position + '</td>';
      html += '  <td class="name">' + data[i].name + '</td>';
      html += '  <td class="commander">' + data[i].commander + '</td>';
      html += '  <td class="phoneid"><a href="#">' + data[i].phoneid + '</a></td>';
      html += '  <td class="life">' + data[i].life + '</td>';
      html += '</tr>';
      $('#players').append(html);
      $.getJSON('/player/active?action=get&tableid={{tableid}}', function(data){
        $('.dataRow[rel="' + data.position + '"]').addClass("highlight");
      });
      $('.phoneid > a').off('click').click(function(){
        $.getJSON('/user/?phoneid=' + $(this).text(), function(data){
          $('.userRow').remove();
          var html = '';
          for(i in data){
            html += '<tr class="userRow">';
            html += '<td>' + data[i]['tableid'] + '</td>';
            html += '<td>' + data[i]['position'] + '</td>';
            html += '<td>' + data[i]['name'] + '</td>';
            html += '<td>' + data[i]['commander'] + '</td>';
            html += '<td>' + data[i]['life'] + '</td>';
            html += '<td>' + data[i]['timestamp'] + '</td>';
            html += '</tr>';
          }
          $('#log').append(html);
        });
      })
    }
  });
}
$(document).ready(function(){
  refreshTable();
});
</script>